<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>èªªè©±å§ï¼</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { font-size: 1.2em; padding: 10px 20px; }
        h3 { margin-top: 30px; }
    </style>
</head>
<body>
    <h1>ğŸ—£ï¸ å°èªèªéŸ³èŠå¤©æ©Ÿå™¨äºº</h1>
    <button id="recordBtn">ğŸ¤ é–‹å§‹è¬›è©±</button>

    <h3>ğŸ“ è¾¨è­˜æ–‡å­—ï¼š</h3>
    <div id="resultText">ï¼ˆç­‰å¾…ä¸­ï¼‰</div>

    <h3>ğŸ¤– Gemini å›æ‡‰ï¼š</h3>
    <div id="geminiReply">ï¼ˆç­‰å¾…ä¸­ï¼‰</div>

    <h3>ğŸ”Š èªéŸ³æ’­æ”¾ï¼š</h3>
    <audio id="responseAudio" controls></audio>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        document.getElementById("recordBtn").addEventListener("click", async () => {
            await fetch("/start-record", { method: "POST" });

            audioChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                // ğŸ” é¡¯ç¤ºéŒ„éŸ³çµæœé•·åº¦
                console.log("ğŸ§ éŒ„éŸ³çµæŸï¼Œå¤§å°ï¼š", audioBlob.size, "bytes");

                // âš ï¸ è‹¥éŒ„éŸ³å¤ªçŸ­ï¼Œæç¤ºé‡è©¦
                if (audioBlob.size < 5000) {
                    alert("âš ï¸ éŒ„éŸ³å¤ªçŸ­æˆ–æ²’æœ‰è²éŸ³ï¼Œè«‹å¤§è²èªªè©±å¾Œå†è©¦ä¸€æ¬¡ï¼");
                    document.getElementById("recordBtn").disabled = false;
                    document.getElementById("recordBtn").textContent = "ğŸ¤ å†è¬›ä¸€æ¬¡";
                    return;
                }

                const formData = new FormData();
                formData.append("audio", audioBlob, "recording.webm");

                document.getElementById("resultText").textContent = "â³ è¾¨è­˜ä¸­...";
                document.getElementById("geminiReply").textContent = "â³ ç­‰å¾… Gemini å›æ‡‰...";

                try {
                    const res = await fetch("/upload", { method: "POST", body: formData });
                    const data = await res.json();

                    document.getElementById("resultText").textContent = data.recognized_text || "âŒ æœªè¾¨è­˜";
                    document.getElementById("geminiReply").textContent = data.gemini_reply || "âŒ ç„¡å›æ‡‰";

                    if (data.audio_base64) {
                        const audio = document.getElementById("responseAudio");
                        audio.src = data.audio_base64;
                        audio.play();
                    } else {
                        alert("âŒ æ²’æœ‰èªéŸ³å¯æ’­æ”¾");
                    }
                } catch (err) {
                    alert("âŒ ç³»çµ±éŒ¯èª¤");
                    console.error(err);
                }

                document.getElementById("recordBtn").disabled = false;
                document.getElementById("recordBtn").textContent = "ğŸ¤ å†è¬›ä¸€æ¬¡";
            };


            mediaRecorder.start();
            document.getElementById("recordBtn").textContent = "ğŸ™ï¸ éŒ„éŸ³ä¸­ï¼ˆ10 ç§’ï¼‰...";
            document.getElementById("recordBtn").disabled = true;

            setTimeout(() => {
                mediaRecorder.stop();
                document.getElementById("recordBtn").textContent = "ğŸ¤ å†è¬›ä¸€æ¬¡";
                document.getElementById("recordBtn").disabled = false;
            }, 10000);
        });
    </script>
</body>
</html>
